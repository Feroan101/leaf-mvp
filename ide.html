<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code IDE - Leaf Singularity</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
            height: 100vh;
        }

        .ide-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-bar {
            background: #323233;
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-bottom: 1px solid #1e1e1e;
            gap: 16px;
            z-index: 10;
        }

        .top-bar-title {
            font-size: 13px;
            font-weight: 600;
            color: #cccccc;
        }

        .top-bar-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .top-bar-btn:hover {
            background: #1177bb;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            background: #252526;
            width: 250px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #1e1e1e;
            padding: 10px;
        }

        .sidebar-header {
            font-size: 11px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .file-info {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #888;
        }

        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            background: #252526;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #2d2d2d;
            align-items: center;
        }

        .editor-btn {
            background: #16825d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 14px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .editor-btn:hover {
            background: #1a9870;
        }

        .language-select {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #454545;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }

        .code-editor {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            padding: 16px;
            border: none;
            outline: none;
            resize: none;
            line-height: 1.6;
            tab-size: 4;
            overflow: auto;
        }

        .editor-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6a737d;
            font-size: 14px;
        }

        .bottom-panel {
            background: #1e1e1e;
            border-top: 1px solid #2d2d2d;
            display: flex;
            flex-direction: column;
            height: 200px;
            min-height: 100px;
            max-height: 500px;
            overflow: hidden;
        }

        .bottom-panel-header {
            background: #252526;
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 16px;
            border-bottom: 1px solid #1e1e1e;
        }

        .panel-tab {
            cursor: pointer;
            padding: 8px 12px;
            font-size: 13px;
            color: #969696;
        }

        .panel-tab.active {
            color: #d4d4d4;
            border-bottom: 2px solid #3794ff;
        }

        .panel-content {
            flex: 1;
            overflow: hidden;
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        .output-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            padding: 12px;
            height: 100%;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .output-success {
            color: #4ec9b0;
        }

        .output-error {
            color: #f48771;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="ide-container">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="top-bar-title">üíª Code IDE</div>
            <button class="top-bar-btn" onclick="saveFile()">üíæ Save</button>
            <button class="top-bar-btn" onclick="downloadFile()">üì• Download</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">üìÑ Current File</div>
                <div class="file-info" id="fileInfo">Loading...</div>
            </div>

            <!-- EDITOR AREA -->
            <div class="editor-area">
                <!-- EDITOR TOOLBAR -->
                <div class="editor-toolbar">
                    <button class="editor-btn" onclick="runCode()">‚ñ∂ Run Code</button>
                    <select class="language-select" id="languageSelect" onchange="changeLanguage()">
                        <option value="javascript">JavaScript (Node.js)</option>
                        <option value="python3">Python 3</option>
                        <option value="java">Java</option>
                        <option value="c">C</option>
                        <option value="cpp">C++</option>
                        <option value="php">PHP</option>
                        <option value="ruby">Ruby</option>
                    </select>
                </div>

                <!-- CODE EDITOR TEXTAREA -->
                <textarea id="codeEditor" class="code-editor" spellcheck="false" placeholder="Loading file from server..."></textarea>

                <!-- PLACEHOLDER -->
                <div class="editor-placeholder" id="placeholder" style="display: none;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üíª</div>
                    <div>No file loaded</div>
                    <div style="font-size: 12px; color: #555; margin-top: 8px;">Make sure server.py is running</div>
                </div>
            </div>
        </div>

        <!-- BOTTOM PANEL -->
        <div class="bottom-panel">
            <div class="bottom-panel-header">
                <div class="panel-tab active" onclick="switchTab('output')">üìã Output</div>
                <div class="panel-tab" onclick="switchTab('terminal')">‚å®Ô∏è Terminal</div>
            </div>
            <div class="panel-content active" id="outputPanel">
                <div class="output-panel" id="outputContent">Ready to run your code...</div>
            </div>
            <div class="panel-content" id="terminalPanel">
                <div class="output-panel" id="terminalContent">‚úÖ Using JDoodle API via Backend Proxy</div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:5000';
        
        let currentFile = {
            name: null,
            language: 'javascript',
            content: ''
        };

        const LANGUAGE_MAP = {
            'javascript': 'nodejs',
            'python3': 'python3',
            'java': 'java',
            'c': 'c',
            'cpp': 'cpp',
            'php': 'php',
            'ruby': 'ruby'
        };

        // LOAD FILE ON PAGE LOAD
        window.addEventListener('DOMContentLoaded', loadFile);

        async function loadFile() {
            console.log('üîÑ Loading file from backend...');
            document.getElementById('fileInfo').textContent = 'Loading...';
            
            try {
                console.log('üì° Fetching from:', BACKEND_URL + '/latest-code');
                
                // Get latest code file
                const latestRes = await fetch(`${BACKEND_URL}/latest-code`, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });

                console.log('Response status:', latestRes.status);
                
                if (!latestRes.ok) {
                    throw new Error(`Server error: ${latestRes.status}`);
                }

                const latestData = await latestRes.json();
                const filename = latestData.filename;

                console.log('üìÅ Latest file:', filename);

                if (!filename) {
                    console.warn('‚ùå No code files found');
                    document.getElementById('fileInfo').innerHTML = '<span style="color: #f48771;">No files found</span>';
                    showPlaceholder();
                    showOutput('‚ùå No code files in uploads folder. Drop a file in index.html first!', true);
                    return;
                }

                // Get file content
                const fileRes = await fetch(`${BACKEND_URL}/file/${filename}`, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });

                if (!fileRes.ok) {
                    throw new Error(`Failed to fetch file: ${fileRes.status}`);
                }

                const content = await fileRes.text();
                console.log('üìÑ File loaded, size:', content.length, 'bytes');

                // Detect language from extension
                const ext = filename.split('.').pop().toLowerCase();
                const langMap = {
                    'js': 'javascript',
                    'py': 'python3',
                    'java': 'java',
                    'c': 'c',
                    'cpp': 'cpp',
                    'php': 'php',
                    'rb': 'ruby',
                    'ts': 'javascript'
                };

                currentFile.name = filename;
                currentFile.language = langMap[ext] || 'javascript';
                currentFile.content = content;

                // Update UI
                updateFileInfo();
                showEditor();
                document.getElementById('codeEditor').value = content;
                document.getElementById('languageSelect').value = currentFile.language;

                console.log('‚úÖ File ready to edit!');
                showOutput('‚úÖ File loaded: ' + filename, false);

            } catch (error) {
                console.error('‚ùå Load error:', error);
                document.getElementById('fileInfo').innerHTML = '<span style="color: #f48771;">Error loading</span>';
                
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Cannot reach server at localhost:5000\n\n‚ö†Ô∏è Make sure:\n1. server.py is running\n2. Flask-CORS is installed (pip install flask-cors)\n3. Port 5000 is not blocked';
                }
                
                showOutput(errorMsg, true);
                showPlaceholder();
            }
        }

        function updateFileInfo() {
            const info = document.getElementById('fileInfo');
            if (currentFile.name) {
                info.innerHTML = `<strong>${currentFile.name}</strong><br><small>Lang: ${currentFile.language}</small>`;
            }
        }

        function showEditor() {
            document.getElementById('codeEditor').style.display = 'block';
            document.getElementById('placeholder').style.display = 'none';
        }

        function showPlaceholder() {
            document.getElementById('codeEditor').style.display = 'none';
            document.getElementById('placeholder').style.display = 'flex';
        }

        function saveFile() {
            const editor = document.getElementById('codeEditor');
            currentFile.content = editor.value;
            showOutput('üíæ Saved to memory (Ctrl+S)', false);
            console.log('File updated:', currentFile.content.length, 'bytes');
        }

        function downloadFile() {
            if (!currentFile.name) {
                alert('‚ùå No file to download');
                return;
            }
            const blob = new Blob([currentFile.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.name;
            a.click();
            URL.revokeObjectURL(url);
            showOutput('üì• Downloaded: ' + currentFile.name, false);
        }

        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            currentFile.language = select.value;
            updateFileInfo();
            showOutput('üîÑ Language: ' + currentFile.language, false);
        }

        async function runCode() {
            if (!currentFile.name) {
                showOutput('‚ùå No file loaded', true);
                return;
            }

            const code = document.getElementById('codeEditor').value;
            const jdoodleLang = LANGUAGE_MAP[currentFile.language];

            if (!jdoodleLang) {
                showOutput('‚ùå Language not supported: ' + currentFile.language, true);
                return;
            }

            showOutput('‚è≥ Running...', false);
            switchTab('output');

            try {
                console.log('üî• Calling backend /run endpoint');
                console.log('Code:', code);
                console.log('Language:', jdoodleLang);
                
                const payload = {
                    script: code,
                    language: jdoodleLang,
                    stdin: ''
                };

                console.log('Payload:', payload);

                const res = await fetch(BACKEND_URL + '/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                console.log('üî• Full Response:', result);

                let output = '';
                
                // JDoodle returns output in the "output" field
                if (result.output) {
                    output = result.output;
                    console.log('‚úÖ Got output:', output);
                }
                
                // Check for errors
                if (result.error) {
                    output = (output ? output + '\n---ERROR---\n' : '') + result.error;
                    console.log('‚ùå Got error:', result.error);
                }
                
                // If still no output, show success
                if (!output) {
                    output = '‚úÖ Code executed successfully (no output)';
                    console.log('No output, showing success message');
                }

                const isError = result.error ? true : false;
                console.log('Is error?', isError);
                showOutput(output, isError);

            } catch (error) {
                console.error('Run error:', error);
                showOutput('‚ùå Error: ' + error.message, true);
            }
        }

        function showOutput(text, isError = false) {
            const output = document.getElementById('outputContent');
            output.textContent = text;
            output.className = `output-panel ${isError ? 'output-error' : 'output-success'}`;
            console.log('Display:', text, 'isError:', isError);
        }

        function switchTab(tab) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel-content').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Panel').classList.add('active');
        }

        // KEYBOARD SHORTCUTS
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
        });

        console.log('‚úÖ IDE Ready - Using JDoodle via Backend Proxy');
    </script>
</body>
</html>